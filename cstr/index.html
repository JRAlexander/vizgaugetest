<html>

<head>
    <script type="text/javascript" src="./src/gauge.js"> </script>
    <script language="JavaScript">
        /*
         * Copyright: Microsoft 2022.
         *
         * An example visualizer for use with CSTR simulators.
         */
        const svgns = "http://www.w3.org/2000/svg";
        const params = new URLSearchParams(window.location.search);
        const darkMode = params.get("_theme") === "dark";
        const debug = params.get("debug") === "true";

        // optional overrides for parameter names
        const crKey = "Cr";
        const trKey = "Tr";
        const tcKey = "Tc";

        // set on load()
        let svgDoc = undefined;
        let crgauge = undefined;
        let trgauge = undefined;
        let tcgauge = undefined;

        // utility setAttributes
        function setAttributes(el, attributes) {
            for (var attr in attributes) el.setAttribute(attr, attributes[attr]);
        }

        // setup the document
        function setup() {

            try {
                crgauge = Gauge(
                    document.getElementById("cr_gauge"),
                    {
                        min: -0.1,
                        max: 12,
                        dialStartAngle: 180,
                        dialEndAngle: 0,
                        value: 0,
                        viewBox: "0 0 100 57",
                        label: function (value) {
                             return "Cr: " + value;
                        },
                        color: function (value) {
                            if (value < 20) {
                                return "#5ee432";
                            } else if (value < 40) {
                                return "#fffa50";
                            } else if (value < 60) {
                                return "#f7aa38";
                            } else {
                                return "#ef4655";
                            }
                        }
                    }
                );

                trgauge = Gauge(
                    document.getElementById("tr_gauge"),
                    {
                        min: 10,
                        max: 800,
                        dialStartAngle: 180,
                        dialEndAngle: 0,
                        value: 0,
                        viewBox: "0 0 100 57",
                        label: function (value) {
                            return "Tr: " + value;
                        },
                        color: function (value) {
                            if (value < 200) {
                                return "#5ee432";
                            } else if (value < 400) {
                                return "#fffa50";
                            } else if (value < 600) {
                                return "#f7aa38";
                            } else {
                                return "#ef4655";
                            }
                        }
                    }
                );

                tcgauge = Gauge(
                    document.getElementById("tc_gauge"),
                    {
                        min: 10,
                        max: 800,
                        dialStartAngle: 180,
                        dialEndAngle: 0,
                        value: 297.9798,
                        viewBox: "0 0 100 57",
                        label: function (value) {
                            return "Tc: " + value;
                        },
                        color: function (value) {
                            if (value < 200) {
                                return "#5ee432";
                            } else if (value < 400) {
                                return "#fffa50";
                            } else if (value < 600) {
                                return "#f7aa38";
                            } else {
                                return "#ef4655";
                            }
                        }
                    }
                );

                // adjust our colors based upon theme.
                if (darkMode) {
                    document.body.style.backgroundColor = "#333";
                    document.body.style.color = "white";
                }
            } catch (e) {
                // ignore
            }

            // loading text
            if (debug) {
                const out = document.getElementById("out");
                out.textContent = "Waiting...";
            }
            // initial update
            update({
                state: {
                    Cr: 2.142201781772368,
                    Cref: 2,
                    Tc: 297.9798,
                    Tr: 200,
                    Tref: 373.1311262173828
                },
                action: {
                    Tc_adjust: 0.12269001454114914
                },
            });
        }

        // update the visualization from state and action data
        function update(data) {
            // convert message to formatted JSON text for display
            const str = JSON.stringify(data, null, 2);

            if (debug) {
                const out = document.getElementById("out");
                out.textContent = str;
            }

            try {
                // update positions of graphical elements
                // Cr : product specific residual concentration mixture of A and B
                const Cr = parseFloat(data.state["Cr"].toFixed(4));
                
                // Cref: desired concentration
                const Cref = parseFloat(data.state["Cref"].toFixed(4));
                
                // Tr : reactor temperature
                const Tr = parseFloat(data.state["Tr"].toFixed(4));

                //Tref: desired temperature
                const Tref = parseFloat(data.state["Tref"].toFixed(4));

                // Tc : cooling jacket medium temperature
                const Tc = parseFloat(data.state["Tc"].toFixed(4));
                
                // Tc_adjust: coolant temp adjustment
                const Tc_Adjust = parseFloat(data.action["Tc_adjust"].toFixed(4));
                
                //Update gauge values
                crgauge.setValue(Cr, 1);
                trgauge.setValue(Tr, 1);
                tcgauge.setValue(Tc, 1);

                //update labels
                const trefLabel = document.getElementById("tref_label");
                trefLabel.innerHTML = "Desired Temperature: " + Tref;

                const crefLabel = document.getElementById("cref_label");
                crefLabel.innerHTML = "Desired concentration: " + Cref;

                const tcAdjustLabel = document.getElementById("tc_adjust_label");
                tcAdjustLabel.innerHTML = "Coolant Temp Adjustment: " + Tc_Adjust;

            } catch (e) {
                // ignore
            }
        }
        //}
        function init() {
            // on load
            window.addEventListener("load", () => {
                setup();
            });

            // on message
            window.addEventListener(
                "message",
                (event) => {
                    const data = JSON.parse(event.data);
                    update(data);
                },
                false
            );
        }
    </script>
</head>

<body>
    <pre id="out" style="font-size: x-small; display: box; position: absolute"></pre>
    <p>
        Residual Concentration (Cr):
        <div id="cr_gauge" class="gauge-container two" style="font-size: x-small"></div>
    </p>
    <p>
        <label id="cref_label">Desired Concentration:</label>
    </p>
    <p>
        Reactor cooling jacket coolant temperature (Tc):
        <div id="tc_gauge" class="gauge-container two" style="font-size: x-small"></div>
    </p>
    <p>
        <label id="tc_adjust_label">Coolant Temp Adjustment:</label>
    </p>
    <p>
        Reactor Temperature (Tr):
        <div id="tr_gauge" class="gauge-container two" style="font-size: x-small"></div>
    </p>
    <p>
        <label id="tref_label">Desired Temperature:</label>
    </p>

    <script language="JavaScript">
        init();
    </script>
</body>

</html>